<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>ECharts</title>
    <script src="js/common.js"></script>
    <script src="js/reconnecting-websocket.min.js"></script>

    <!-- 引入 echarts.js -->
    <!--    <script src="js/echarts.min.js"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.0.1/dist/echarts.min.js"
            integrity="sha256-CiuyzJ79h36eS2B+4SqzA0elMhSYkPsGmforYbgrYOM=" crossorigin="anonymous"></script>
    <!--    bulma-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
    <!--    <link rel="stylesheet" href="css/bulma.min.css">-->
    <!--    <script defer src="css/all.js"></script>-->

    <style>
        .notification {
            position: fixed;
            display: flex;
            right: 10%;
        }

        #left {
            top: 30px;
        }
    </style>
</head>

<body>
<section class="section">
    <div id="notification"></div>

    <div class="columns">
        <div class="column is-2-desktop">
            <div class="" id="left">
                <div class="field">
                    <div class="control">
                        <label id="iTime"> </label>
                        <!--                        <progress class="progress is-success" value="0" max="100">时间进度</progress>-->
                    </div>

                    <div class="control">
                        <label class="label">周期</label>
                        <label class="radio">
                            <input type="radio" name="period" value="1min" checked>
                            1min
                        </label>
                        <label class="radio">
                            <input type="radio" name="period" value="5min">
                            5min
                        </label>
                        <label class="radio">
                            <input type="radio" name="period" value="30min">
                            30min
                        </label>
                    </div>

                    <div class="control">
                        <label class="radio">
                            <input type="radio" name="period" value="4hour">
                            4hour
                        </label>
                        <label class="radio">
                            <input type="radio" name="period" value="1day">
                            1day
                        </label>
                    </div>

                    <div class="control">
                        <label class="label">数量</label>
                        <label class="radio">
                            <input type="radio" name="kSize" value="20">
                            20
                        </label>
                        <label class="radio">
                            <input type="radio" name="kSize" value="50" checked>
                            50
                        </label>
                        <label class="radio">
                            <input type="radio" name="kSize" value="100">
                            100
                        </label>
                        <label class="radio">
                            <input type="radio" name="kSize" value="240">
                            240
                        </label>
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                        <input class="input" type="text" placeholder="history server" id="iHistoryServer">
                    </div>
                </div>

                <div class="field is-grouped">
                    <div class="control">
                        <button class="button is-link" onclick="setPeriod()">确定</button>
                    </div>
                </div>
            </div>
            <HR>
            <div class="" id="tips">
                <h1 class="title">突破(惯性加速)</h1>
                <div class="control">
                    <P class="tag is-danger"> 收敛 </P>
                    放量突破
                </div>
                <div class="control">
                    <P class="tag is-danger"> 旗形 </P>
                    2踩缩量不破位
                </div>
                <div class="control">
                    <P class="tag is-warning"> 震荡 </P>
                    调整破位3高2低收敛
                </div>
                <hr>

                <h1 class="title">翻转(只做大方向)</h1>
                <div class="control">
                    <P class="tag is-danger"> 1/ VOL 背离 </P>
                </div>
                <div class="control">
                    <P class="tag is-warning"> 2/ DIF 背离 </P>
                </div>
                <div class="control">
                    <P class="tag is-danger"> 3/ UP-DN 下降 </P>
                </div>
                <div class="control">
                    <P class="tag is-warning"> 4/ 二爆缩量 </P>
                </div>
                <hr>
                <h1 class="title">性价比（20X）</h1>
                <div class="control">
                    <P class="tag is-success"> 止盈 </P>
                </div>
                <div class="control">
                    <P class="tag is-danger"> 止损（初K高底点） </P>
                </div>

            </div>
        </div>
        <div class="column">
            <div id="main" style="height:900px;"></div>
            <progress class="progress is-success" value="0" max="100">时间进度</progress>

        </div>

    </div>


    <!--    <div class="container" id="content">-->
    <!--
        <div class="container">
            <div id="modal" class="modal is-active">
                <div class="modal-background"></div>
                <div class="modal-content">
                    <div class="box">
                        <article class="media">
                            <div class="media-content">
                                <div class="control">
                                    周期选择：
                                    <label class="radio">
                                        <input type="radio" name="period" value="1min" checked>
                                        1min
                                    </label>
                                    <label class="radio">
                                        <input type="radio" name="period" value="5min">
                                        5min
                                    </label>
                                    <label class="radio">
                                        <input type="radio" name="period" value="30min">
                                        30min
                                    </label>
                                </div>

                                <div class="control">
                                    K线数量：
                                    <label class="radio">
                                        <input type="radio" name="kSize" value="20">
                                        20
                                    </label>
                                    <label class="radio">
                                        <input type="radio" name="kSize" value="50" checked>
                                        50
                                    </label>
                                    <label class="radio">
                                        <input type="radio" name="kSize" value="100">
                                        100
                                    </label>
                                    <label class="radio">
                                        <input type="radio" name="kSize" value="240">
                                        240
                                    </label>
                                    <label class="radio">
                                        <input type="radio" name="kSize" value="480">
                                        480
                                    </label>
                                    <label class="radio">
                                        <input type="radio" name="kSize" value="720">
                                        720
                                    </label>
                                    <label class="radio">
                                        <input type="radio" name="kSize" value="1440">
                                        1440
                                    </label>
                                </div>
                            </div>
                        </article>
                    </div>
                </div>
                <button class="modal-close is-large" aria-label="close" onclick="setPeriod()"></button>
            </div>

        </div>
    -->


</section>


<!-- 为ECharts准备一个具备大小（宽高）的Dom -->
<script type="text/javascript">
    // 基于准备好的dom，初始化echarts实例
    let myChart = echarts.init(document.getElementById('main'));
    let labelFont = 'bold 12px Sans-serif';

    function calculateMA(dayCount, data) {
        let result = [];
        for (let i = 0, len = data.length; i < len; i++) {
            if (i < dayCount) {
                result.push('-');
                continue;
            }
            let sum = 0;
            for (let j = 0; j < dayCount; j++) {
                sum += data[i - j][1];
            }
            result.push((sum / dayCount).toFixed(2));
        }
        return result;
    }

    const calcBOLL = (priceArray) => {
        //移动平均线周期为20
        let maDays = 20, tickBegin = maDays - 1, maSum = 0, p = 0;
        let ups = [], mas = [], lows = [];
        for (let i = 0; i < priceArray.length; i++) {
            let c = priceArray[i], ma, md, bstart, mdSum;
            maSum += c;
            if (i >= tickBegin) {
                maSum = maSum - p;
                ma = maSum / maDays;
                mas.push(Math.round(ma));
                bstart = i - tickBegin;
                p = priceArray[bstart];
                mdSum = priceArray.slice(bstart, bstart + maDays).reduce(function (a, b) {
                    return a + Math.pow(b - ma, 2);
                }, 0);
                md = Math.sqrt(mdSum / maDays);
                ups.push(Math.round(ma + 2 * md));
                lows.push(Math.round(ma - 2 * md));
            } else {
                //ugly constant, just keep the same type for client
                ups.push('-');
                mas.push('-');
                lows.push('-');
            }
        }
        return {"up": ups, "mid": mas, "low": lows};
    };
    const macd = function (ticks) {
        let ema12 = [], ema26 = [], diffs = [], deas = [], bars = [];
        for (let i = 0; i < ticks.length; i++) {
            let c = ticks[i];
            if (i === 0) {
                ema12.push(c);
                ema26.push(c);
                deas.push(0);
            } else {
                ema12.push(ema(ema12[i - 1], c, 12));
                ema26.push(ema(ema26[i - 1], c, 26));
            }
            diffs.push(ema12[i] - ema26[i]);
            if (i !== 0) {
                deas.push(dea(deas[i - 1], diffs[i]));
            }
            bars.push((diffs[i] - deas[i]) * 2);
        }
        return {diffs: diffs, deas: deas, bars: bars};
    };
    const ema = function (lastEma, closePrice, units) {
        return (lastEma * (units - 1) + closePrice * 2) / (units + 1);
    };
    const dea = function (lastDea, curDiff) {
        return (lastDea * 8 + curDiff * 2) / 10;
    };
    const bkm = (value) => {
        if (value >= 0 && value < 1000) {
            return value
        } else if (value >= 1000 && value < 1000 * 1000) {
            return (value / 1000) + "K"
        } else {
            return (value / (1000 * 1000)) + "M"
        }
    };

    //[open, close, lowest, highest] （即：[开盘值, 收盘值, 最低值, 最高值]）
    let lastClose = 0;
    let dates = [];//["2016-03-29", "2016-03-30", "2016-03-31", "2016-04-01", "2016-04-04", "2016-04-05", "2016-04-06", "2016-04-07", "2016-04-08", "2016-04-11", "2016-04-12", "2016-04-13", "2016-04-14", "2016-04-15", "2016-04-18", "2016-04-19", "2016-04-20", "2016-04-21", "2016-04-22", "2016-04-25", "2016-04-26", "2016-04-27", "2016-04-28", "2016-04-29", "2016-05-02", "2016-05-03", "2016-05-04", "2016-05-05", "2016-05-06", "2016-05-09", "2016-05-10", "2016-05-11", "2016-05-12", "2016-05-13", "2016-05-16", "2016-05-17", "2016-05-18", "2016-05-19", "2016-05-20", "2016-05-23", "2016-05-24", "2016-05-25", "2016-05-26", "2016-05-27", "2016-05-31", "2016-06-01", "2016-06-02", "2016-06-03", "2016-06-06", "2016-06-07", "2016-06-08", "2016-06-09", "2016-06-10", "2016-06-13", "2016-06-14", "2016-06-15", "2016-06-16", "2016-06-17", "2016-06-20", "2016-06-21", "2016-06-22"];
    let dataK = [];//[[17512.58, 17633.11, 17434.27, 17642.81, 86160000], [17652.36, 17716.66, 17652.36, 17790.11, 79330000], [17716.05, 17685.09, 17669.72, 17755.7, 102600000], [17661.74, 17792.75, 17568.02, 17811.48, 104890000], [17799.39, 17737, 17710.67, 17806.38, 85230000], [17718.03, 17603.32, 17579.56, 17718.03, 115230000], [17605.45, 17716.05, 17542.54, 17723.55, 99410000], [17687.28, 17541.96, 17484.23, 17687.28, 90120000], [17555.39, 17576.96, 17528.16, 17694.51, 79990000], [17586.48, 17556.41, 17555.9, 17731.63, 107100000], [17571.34, 17721.25, 17553.57, 17744.43, 81020000], [17741.66, 17908.28, 17741.66, 17918.35, 91710000], [17912.25, 17926.43, 17885.44, 17962.14, 84510000], [17925.95, 17897.46, 17867.41, 17937.65, 118160000], [17890.2, 18004.16, 17848.22, 18009.53, 89390000], [18012.1, 18053.6, 17984.43, 18103.46, 89820000], [18059.49, 18096.27, 18031.21, 18167.63, 100210000], [18092.84, 17982.52, 17963.89, 18107.29, 102720000], [17985.05, 18003.75, 17909.89, 18026.85, 134120000], [17990.94, 17977.24, 17855.55, 17990.94, 83770000], [17987.38, 17990.32, 17934.17, 18043.77, 92570000], [17996.14, 18041.55, 17920.26, 18084.66, 109090000], [18023.88, 17830.76, 17796.55, 18035.73, 100920000], [17813.09, 17773.64, 17651.98, 17814.83, 136670000], [17783.78, 17891.16, 17773.71, 17912.35, 80100000], [17870.75, 17750.91, 17670.88, 17870.75, 97060000], [17735.02, 17651.26, 17609.01, 17738.06, 95020000], [17664.48, 17660.71, 17615.82, 17736.11, 81530000], [17650.3, 17740.63, 17580.38, 17744.54, 80020000], [17743.85, 17705.91, 17668.38, 17783.16, 85590000], [17726.66, 17928.35, 17726.66, 17934.61, 75790000], [17919.03, 17711.12, 17711.05, 17919.03, 87390000], [17711.12, 17720.5, 17625.38, 17798.19, 88560000], [17711.12, 17535.32, 17512.48, 17734.74, 86640000], [17531.76, 17710.71, 17531.76, 17755.8, 88440000], [17701.46, 17529.98, 17469.92, 17701.46, 103260000], [17501.28, 17526.62, 17418.21, 17636.22, 79120000], [17514.16, 17435.4, 17331.07, 17514.16, 95530000], [17437.32, 17500.94, 17437.32, 17571.75, 111990000], [17507.04, 17492.93, 17480.05, 17550.7, 87790000], [17525.19, 17706.05, 17525.19, 17742.59, 86480000], [17735.09, 17851.51, 17735.09, 17891.71, 79180000], [17859.52, 17828.29, 17803.82, 17888.66, 68940000], [17826.85, 17873.22, 17824.73, 17873.22, 73190000], [17891.5, 17787.2, 17724.03, 17899.24, 147390000], [17754.55, 17789.67, 17664.79, 17809.18, 78530000], [17789.05, 17838.56, 17703.55, 17838.56, 75560000], [17799.8, 17807.06, 17689.68, 17833.17, 82270000], [17825.69, 17920.33, 17822.81, 17949.68, 71870000], [17936.22, 17938.28, 17936.22, 18003.23, 78750000], [17931.91, 18005.05, 17931.91, 18016, 71260000], [17969.98, 17985.19, 17915.88, 18005.22, 69690000], [17938.82, 17865.34, 17812.34, 17938.82, 90540000], [17830.5, 17732.48, 17731.35, 17893.28, 101690000], [17710.77, 17674.82, 17595.79, 17733.92, 93740000], [17703.65, 17640.17, 17629.01, 17762.96, 94130000], [17602.23, 17733.1, 17471.29, 17754.91, 91950000], [17733.44, 17675.16, 17602.78, 17733.44, 248680000], [17736.87, 17804.87, 17736.87, 17946.36, 99380000], [17827.33, 17829.73, 17799.8, 17877.84, 85130000], [17832.67, 17780.83, 17770.36, 17920.16, 89440000]];
    let priceClose = [];

    let volumesBuy = [];//[143050, 0, 47326, 152548, 100660, 32466, 0, 4322, 46648, 41742, 47396, 26136, 94354, 76932, 53270, 40786, 17370, 56968, 0, 0, 0, 0, 109670, 73426, 78790, 63704, 92978, 28094, 28204, 67910, 36274, 41358, 111246, 30426, 214916, 168946, 137274, 60428, 45596, 44474, 22876, 240782, 111448, 199688, 181994, 239876, 208088, 83926, 51286, 153904, 0];
    let volumesSell = [];
    let volAll = [];

    let volNB = [];
    let volNS = [];

    let volumesCqBuy = [];
    let volumesCqSell = [];

    let vrPrice = [];
    let vrBuy = [];
    let vrSell = [];

    // let dataMA5 = [];//calculateMA(5, dataK);
    // let dataMA10 = [];//calculateMA(10, dataK);
    // let dataMA20 = [];//calculateMA(20, dataK);


    let diff = [];
    let bollUP = [];
    let bollMID = [];
    let bollLOW = [];
    let upDN = [];
    let b30up = 0;
    let b30dn = 0;

    const DATA_TYPE = {
        r: "r",
        k: "k",
        init: "init",
    };
    const SAFE_COLOR = {
        red: '#CC3300',
        green: '#009933',
        grey: '#BBBBBB',
        blue: '#3333CC',
        yellow: '#FF9900',
        black: '#222222'
    };


    const HOST = "duokong.info";
    const initWS = () => {
        const wsUrl = "ws://" + HOST + ":10001";//localhost 根据实际情况替换成 响应的ip 或者域名
        // const wsUrl = "ws://" + "localhost" + ":10001";//localhost 根据实际情况替换成 响应的ip 或者域名
        let ws = new ReconnectingWebSocket(wsUrl);

        ws.onopen = function (evt) {
            notify('连接成功')
        };

        ws.onmessage = function (evt) {
            try {
                let msgObj = JSON.parse(evt.data);
                console.log("msgObj", msgObj);
                updateList(msgObj);

            } catch (e) {
                console.error("evt", evt);
            }
        };

        ws.onclose = function (evt) {
            notify('连接断开, 重新连接...')
        };
    };

    function notify(text) {
        let div = document.createElement('div');
        div.setAttribute("class", "notification");
        div.innerText = text;

        let notify = qs("#notification");
        notify.append(div);

        let sid = setInterval(function () {
            notify.removeChild(div);
            clearInterval(sid);
        }, 2000)
    }


    /*初始化数据*/
    option = {
        // animation: true,
        legend: {
            orient: "vertical",
            left: 20,
            data: ['vrBuy','vrSell']
        },

        tooltip: {
            trigger: 'axis',
            axisPointer: {

                animation: false,
                type: 'cross',
                lineStyle: {
                    color: SAFE_COLOR.blue,
                    width: 1,
                    opacity: 0.5
                },
            },

            /*
            开: 39370收: 39394低: 39370高: 39395<br>

            up:"-"<br>mid:"-"<br>low:"-"<br>

            VOL_buy:21824<br>VOL_sell:0<br>VOL_All:24680<br>macd:-4.313505883292237<br>CQ_buy:0<br>CQ_sell:0<br>
             */
            formatter: function (value) {

                let obj = {};

                let html = '<div>';
                html += '<pre>'
                let k = value[0].value;
                html += "开：" + Math.round(k[1]) + " 收：" + Math.round(k[2]) + " 低：" + Math.round(k[3]) + " 高：" + Math.round(k[4]) + "\n";

                for (let i = 1; i < value.length; i++) {
                    let item = value[i];
                    obj[item.seriesName] = Math.round(item.value);
                }

                // console.log(obj)


                html += 'UP-DN：' + (obj.upDN)
                    + ' <span style="color:#CC3300;">差：' + (obj.macd) + '</span>\n';
                html += '总：' + (bkm(obj.VOL_All + obj.VOL_buy + obj.VOL_sell))
                    + ' 买：' + bkm(obj.VOL_buy)
                    + ' 卖：' + bkm(obj.VOL_sell)
                    + ' 多：' + bkm(obj.CQ_buy)
                    + ' 空：' + bkm(obj.CQ_sell);
                html += '</pre>';
                html += '</div>';

                // console.log('html', html);
                return html

            },
            // position: [0, -20],
        },
        axisPointer: {
            link: [{
                xAxisIndex: [0, 1, 2, 3, 4]
            }]
        },
        dataZoom: [{
            type: 'slider',
            xAxisIndex: [0, 1, 2, 3, 4,5],
            realtime: true,
            // start: 50,
            // end: 100,
            top: 0,
            height: 20,
            handleIcon: 'M10.7,11.9H9.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4h1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
            handleSize: '100%'
        }, {
            type: 'inside',
            xAxisIndex: [0, 1, 2, 3, 4,5],
            // top: 30,
            height: 20
        }],
        xAxis: [{
            type: 'category',
            data: dates,
            boundaryGap: true,
            axisLabel: {
                formatter: function (value) {
                    return echarts.format.formatTime('hh:mm', value);
                }
            },
            min: 'dataMin',
            max: 'dataMax',
            axisPointer: {
                show: true
            }
        }, {
            type: 'category',
            gridIndex: 1,
            data: dates,
            scale: true,
            boundaryGap: true,
            splitLine: {show: false},
            axisLabel: {show: false},
            axisTick: {show: false},
            axisLine: {lineStyle: {color: SAFE_COLOR.grey}},
            splitNumber: 20,
            min: 'dataMin',
            max: 'dataMax',
        }, {
            type: 'category',
            gridIndex: 2,
            data: dates,
            scale: true,
            boundaryGap: true,
            splitLine: {show: true},
            axisLabel: {show: true},
            axisTick: {show: true},
            axisLine: {lineStyle: {color: SAFE_COLOR.grey}},
            splitNumber: 20,
            min: 'dataMin',
            max: 'dataMax',
        }, {
            type: 'category',
            gridIndex: 3,
            data: dates,
            scale: true,
            boundaryGap: true,
            splitLine: {show: true},
            axisLabel: {show: true},
            axisTick: {show: true},
            axisLine: {lineStyle: {color: SAFE_COLOR.grey}},
            splitNumber: 20,
            min: 'dataMin',
            max: 'dataMax',
        }, {
            type: 'category',
            gridIndex: 4,
            data: dates,
            scale: true,
            boundaryGap: true,
            splitLine: {show: true},
            axisLabel: {show: true},
            axisTick: {show: true},
            axisLine: {lineStyle: {color: SAFE_COLOR.grey}},
            splitNumber: 20,
            min: 'dataMin',
            max: 'dataMax',
        },{
            type: 'value'
        }],
        yAxis: [{
            scale: false,//min max 存在是 scale 无效
            max: 'dataMax',
            // min: 'dataMin',
            min: function (value) {
                return value.min - (value.min % 50);
            },
            interval: 100,
            splitNumber: 1,
            axisLine: {lineStyle: {color: SAFE_COLOR.grey}},
            splitLine: {show: true},
            axisTick: {show: true},
            axisLabel: {
                inside: true,
                formatter: function (value, index) {
                    return Math.round(value)
                }
            },
            minorSplitLine: {
                show: true
            },
            minorTick: {
                show: true,
                splitNumber: 2,
            },
            position: "right"
        }, {
            scale: true,
            gridIndex: 1,
            splitNumber: 2,
            axisLabel: {
                inside: true,
                show: true,
                // 使用函数模板，函数参数分别为刻度数值（类目），刻度的索引
                formatter: function (value, index) {
                    return bkm(value);
                }
            },
            axisLine: {show: true},
            axisTick: {show: true},
            splitLine: {show: true},
        }, {
            scale: true,
            gridIndex: 2,
            splitNumber: 2,
            axisLabel: {
                inside: true,
                show: true,
                // 使用函数模板，函数参数分别为刻度数值（类目），刻度的索引
                formatter: function (value, index) {
                    return Math.round(value)
                }
            },
            axisLine: {show: true},
            axisTick: {show: true},
            splitLine: {show: true}
        }, {
            scale: true,
            gridIndex: 3,
            splitNumber: 2,
            axisLabel: {
                inside: true,
                show: true,
                // 使用函数模板，函数参数分别为刻度数值（类目），刻度的索引
                formatter: function (value, index) {
                    return bkm(value);
                }
            },
            axisLine: {show: true},
            axisTick: {show: true},
            splitLine: {show: true}
        }, {
            scale: true,
            gridIndex: 4,
            splitNumber: 2,
            axisLabel: {
                inside: true,
                show: true,
                // 使用函数模板，函数参数分别为刻度数值（类目），刻度的索引
                formatter: function (value, index) {
                    return bkm(value);
                }
            },
            axisLine: {show: true},
            axisTick: {show: true},
            splitLine: {show: true}
        },{
            type: 'category',
            data: vrPrice,
            axisLabel: {
                inside: true,
            },
        }],
        grid: [{
            top: 40,
            height: 300
        }, {
            height: 100,
            top: 370
        }, {
            height: 100,
            top: 500
        }, {
            height: 100,
            top: 630
        }, {
            height: 100,
            top: 760
        }],

        graphic: [{
            type: 'group',
            left: 'center',
            top: 70,
            width: 300,
            bounding: 'raw',
            children: [{
                id: 'up',
                type: 'text',
                style: {fill: SAFE_COLOR.yellow, font: labelFont},
                left: 0
            }, {
                id: 'mid',
                type: 'text',
                style: {fill: SAFE_COLOR.black, font: labelFont},
                left: 'center'
            }, {
                id: 'low',
                type: 'text',
                style: {fill: SAFE_COLOR.blue, font: labelFont},
                right: 0
            }]
        }],
        series: [
            {
                name: 'macd',
                type: "line",
                smooth: true,
                xAxisIndex: 2,
                yAxisIndex: 2,
                data: diff
            }, {
                name: 'upDN',
                type: "line",
                smooth: true,
                xAxisIndex: 4,
                yAxisIndex: 4,
                data: upDN
            },
            {
                name: 'CQ_buy',
                type: 'bar',
                xAxisIndex: 3,
                yAxisIndex: 3,
                itemStyle: {
                    color: SAFE_COLOR.red
                },
                stack: 'CQ',
                data: volumesCqBuy
            },
            {
                name: 'CQ_sell',
                type: 'bar',
                xAxisIndex: 3,
                yAxisIndex: 3,
                itemStyle: {
                    color: SAFE_COLOR.green
                },
                stack: 'CQ',
                data: volumesCqSell
            }, {
                name: 'VOL_buy',
                type: 'bar',
                xAxisIndex: 1,
                yAxisIndex: 1,
                itemStyle: {
                    color: SAFE_COLOR.red
                },
                stack: 'vol',
                data: volNB
            },
            {
                name: 'VOL_sell',
                type: 'bar',
                xAxisIndex: 1,
                yAxisIndex: 1,
                itemStyle: {
                    color: SAFE_COLOR.green
                },
                stack: 'vol',
                data: volNS
            }, {
                name: 'VOL_All',
                type: 'bar',
                xAxisIndex: 1,
                yAxisIndex: 1,
                itemStyle: {
                    color: SAFE_COLOR.grey
                },
                stack: 'vol',
                data: volAll
            }, {
                type: 'candlestick',
                name: '日K',
                data: dataK,
                itemStyle: {
                    color: SAFE_COLOR.red,
                    color0: SAFE_COLOR.green,
                    borderColor: SAFE_COLOR.red,
                    borderColor0: SAFE_COLOR.green
                },
                markLine: {
                    symbol: "none",
                    lineStyle: {
                        color: SAFE_COLOR.red
                    },
                    data: [
                        {
                            name: '最新价',
                            yAxis: lastClose
                        }
                    ]
                },
            },
            {
                name: 'vrBuy',
                type: 'bar',
                stack: 'vr',
                xAxisIndex: 5,
                yAxisIndex: 5,
                label: {
                    show: false
                },
                itemStyle: {
                    color: SAFE_COLOR.yellow
                },
                emphasis: {
                    focus: 'series'
                },
                data: vrBuy
            },
            {
                name: 'vrSell',
                type: 'bar',
                stack: 'vr',
                xAxisIndex: 5,
                yAxisIndex: 5,
                label: {
                    show: false
                },
                itemStyle: {
                    color: SAFE_COLOR.blue
                },
                emphasis: {
                    focus: 'series'
                },
                data: vrSell
            }
            /*
            {
                name: 'up',
                type: 'line',
                // data: dataMA5,
                data: bollUP,
                smooth: true,
                showSymbol: false,
                lineStyle: {
                    width: 1,
                    color: SAFE_COLOR.yellow
                }
            }, {
                name: 'mid',
                type: 'line',
                // data: dataMA10,
                data: bollMID,
                smooth: true,
                showSymbol: false,
                lineStyle: {
                    width: 1,
                    color: SAFE_COLOR.black
                }
            }, {
                name: 'low',
                type: 'line',
                // data: dataMA20,
                data: bollLOW,
                smooth: true,
                showSymbol: false,
                lineStyle: {
                    width: 1,
                    color: SAFE_COLOR.blue
                }
            }*/
        ]
    };
    myChart.setOption(option);
    initWS();
    setInterval(() => {
        let date = new Date();
        let seconds = date.getSeconds();
        qs('.progress').value = seconds * 100 / 60;
        qs("#iTime").innerText = date.toLocaleString();
    }, 500);


    /*更新周期*/
    const setPeriod = () => {
        clearData();
        let period = qs("input[name='period']:checked").value;
        let kSize = qs("input[name='kSize']:checked").value;
        let historyService = qs("#iHistoryServer").value ? qs("#iHistoryServer").value : HOST;
        //数据初始化
        let url = "http://" + historyService + ":9001/init?period=" + period + "&size=" + kSize;
        console.log('url', url);
        get(url, {}, (json) => {
            updateList(json.data);
        });
    };
    const clearData = () => {
        dates = [];
        dataK = [];
        priceClose = [];
        lastClose = 0;

        volumesBuy = [];
        volumesSell = [];
        volAll = [];

        volNB = [];
        volNS = [];

        vrPrice = [];
        vrBuy = [];
        vrSell = [];

        volumesCqBuy = [];
        volumesCqSell = [];

        diff = [];
        bollUP = [];
        bollMID = [];
        bollLOW = [];
        upDN = [];
        updateOption();
    }
    const updateList = (obj) => {
        /**
         * 实时最新数据
         */

        if (DATA_TYPE.r === obj.dataType) {
            let index = dates.length - 1;
            const {buy, sell, nb, ns, qpBuy, qpSell, dataK: kline, bollUP, bollDN} = obj
            volumesBuy[index] = buy;
            volumesSell[index] = sell;
            volAll[index] = buy + sell;

            volNB[index] = nb;
            volNS[index] = ns;
            volumesCqBuy[index] = qpBuy;
            volumesCqSell[index] = qpSell;

            b30up = bollUP;
            b30dn = bollDN;

            const {id, open, close, low, high, amount, vol, trade_turnover, count} = kline[0];
            let k = [];
            k.push(open);
            k.push(close);
            k.push(low);
            k.push(high);
            dataK[index] = k;
            priceClose[index] = close;

            let d = close - lastClose;
            if (d > 0) {
                qs('title').innerText = "🔥 【" + Math.round(d) + "】" + close;
            } else {
                qs('title').innerText = "❄️ 【" + Math.round(d) + "】" + close;
            }
            lastClose = close;
        }
        /**
         * 更新已完成K
         */
        if (DATA_TYPE.k === obj.dataType) {
            const {next, qpSell, buy, sell, nb, ns, qpBuy, dataK: kline} = obj;
            //新周期
            dates.push(next);
            volumesBuy.push(0);
            volumesSell.push(0);
            volAll.push(0);
            volNB.push(0);
            volNS.push(0);
            volumesCqBuy.push(0);
            volumesCqSell.push(0);
            dataK.push([]);
            priceClose.push(0);

            //更新
            let index = dates.length - 2;
            volumesBuy[index] = buy[0];
            volumesSell[index] = sell[0];
            volAll[index] = buy[0] + sell[0] - Math.abs(buy[0] - sell[0]);
            volNB[index] = nb[0];
            volNS[index] = ns[0];
            volumesCqBuy[index] = qpBuy[0];
            volumesCqSell[index] = qpSell[0];

            const {fClose: close, fHigh: high, fLow: low, fOpen: open} = kline[0];
            let k = [];
            k.push(open);
            k.push(close);
            k.push(low);
            k.push(high);
            priceClose[index] = close;
            dataK[index] = k;
        }
        /**
         * 初始化数据
         */
        if (DATA_TYPE.init === obj.dataType) {
            const {next, qpSell, buy, sell, nb, ns, qpBuy, dataK: kline, dates: d, vrPrice: vPrice, vrBuy: vBuy, vrSell: vSell} = obj;
            dates = d;
            volumesBuy = buy;
            volumesSell = sell;
            for (let i = 0; i < d.length; i++) {
                volAll[i] = buy[i] + sell[i] - Math.abs(buy[i] - sell[i]);
            }

            volNB = nb;
            volNS = ns;
            volumesCqBuy = qpBuy;
            volumesCqSell = qpSell;

            vrPrice = vPrice;
            vrBuy = vBuy;
            vrSell = vSell;

            for (let i = 0; i < kline.length; i++) {
                const {fclose: close, fhigh: high, flow: low, fopen: open} = kline[i];
                let k = [];
                k.push(open);
                k.push(close);
                k.push(low);
                k.push(high);
                dataK.push(k);
                priceClose.push(close);
            }

            dates.push(next);
            volumesBuy.push(0);
            volumesSell.push(0);
            volAll.push(0);
            volNB.push(0);
            volNS.push(0);
            volumesCqBuy.push(0);
            volumesCqSell.push(0);
            dataK.push([]);
            priceClose.push(0);
        }

        // dataMA5 = calculateMA(5, dataK);
        // dataMA10 = calculateMA(10, dataK);
        // dataMA20 = calculateMA(20, dataK);


        let price = [];
        for (let i = 0; i < dataK.length; i++) {
            price.push(dataK[i][1]);
        }

        const {up, mid, low} = calcBOLL(price);
        bollUP = up;
        bollMID = mid;
        bollLOW = low;
        upDN = [];
        for (let i = 0; i < bollUP.length; i++) {
            upDN.push(up[i] - low[i]);
        }

        const {diffs} = macd(price);
        diff = diffs;
        updateOption();
    };
    const updateOption = () => {
        let opt = {
            ...option,
            xAxis: [{
                type: 'category',
                data: dates,
                boundaryGap: true,
                axisLabel: {
                    formatter: function (value) {
                        return echarts.format.formatTime('hh:mm', value);
                    }
                },
                min: 'dataMin',
                max: 'dataMax',
                axisPointer: {
                    show: true
                }
            }, {
                type: 'category',
                gridIndex: 1,
                data: dates,
                scale: true,
                boundaryGap: true,
                splitLine: {show: false},
                axisLabel: {show: false},
                axisTick: {show: false},
                axisLine: {lineStyle: {color: SAFE_COLOR.grey}},
                splitNumber: 20,
                min: 'dataMin',
                max: 'dataMax',
            }, {
                type: 'category',
                gridIndex: 2,
                data: dates,
                scale: true,
                boundaryGap: true,
                splitLine: {show: true},
                axisLabel: {show: true},
                axisTick: {show: true},
                axisLine: {lineStyle: {color: SAFE_COLOR.grey}},
                splitNumber: 20,
                min: 'dataMin',
                max: 'dataMax',
            }, {
                type: 'category',
                gridIndex: 3,
                data: dates,
                scale: true,
                boundaryGap: true,
                splitLine: {show: true},
                axisLabel: {show: true},
                axisTick: {show: true},
                axisLine: {lineStyle: {color: SAFE_COLOR.grey}},
                splitNumber: 20,
                min: 'dataMin',
                max: 'dataMax',
            }, {
                type: 'category',
                gridIndex: 4,
                data: dates,
                scale: true,
                boundaryGap: true,
                splitLine: {show: true},
                axisLabel: {show: true},
                axisTick: {show: true},
                axisLine: {lineStyle: {color: SAFE_COLOR.grey}},
                splitNumber: 20,
                min: 'dataMin',
                max: 'dataMax',
            },{
                type: 'value'
            }],
            yAxis: [{
                scale: false,//min max 存在是 scale 无效
                max: 'dataMax',
                // min: 'dataMin',
                min: function (value) {
                    return value.min - (value.min % 50);
                },
                // interval: 100,
                // splitNumber: 1,
                axisLine: {lineStyle: {color: SAFE_COLOR.grey}},
                splitLine: {show: true},
                axisTick: {show: true},
                axisLabel: {
                    inside: true,
                    formatter: function (value, index) {
                        return Math.round(value)
                    }
                },
                minorSplitLine: {
                    show: false
                },
                minorTick: {
                    show: false,
                    splitNumber: 2,
                },
                position: "right"
            }, {
                scale: true,
                gridIndex: 1,
                splitNumber: 2,
                axisLabel: {
                    inside: true,
                    show: true,
                    // 使用函数模板，函数参数分别为刻度数值（类目），刻度的索引
                    formatter: function (value, index) {
                        return bkm(value);
                    }
                },
                axisLine: {show: true},
                axisTick: {show: true},
                splitLine: {show: true},
            }, {
                scale: true,
                gridIndex: 2,
                splitNumber: 2,
                axisLabel: {
                    inside: true,
                    show: true,
                    // 使用函数模板，函数参数分别为刻度数值（类目），刻度的索引
                    formatter: function (value, index) {
                        return Math.round(value)
                    }
                },
                axisLine: {show: true},
                axisTick: {show: true},
                splitLine: {show: true}
            }, {
                scale: true,
                gridIndex: 3,
                splitNumber: 2,
                axisLabel: {
                    inside: true,
                    show: true,
                    // 使用函数模板，函数参数分别为刻度数值（类目），刻度的索引
                    formatter: function (value, index) {
                        return bkm(value);
                    }
                },
                axisLine: {show: true},
                axisTick: {show: true},
                splitLine: {show: true}
            }, {
                scale: true,
                gridIndex: 4,
                splitNumber: 2,
                axisLabel: {
                    inside: true,
                    show: true,
                    // 使用函数模板，函数参数分别为刻度数值（类目），刻度的索引
                    formatter: function (value, index) {
                        return bkm(value);
                    }
                },
                axisLine: {show: true},
                axisTick: {show: true},
                splitLine: {show: true}
            },{
                type: 'category',
                data: vrPrice,
                axisLabel: {
                    inside: true,
                },
            }],

            series: [
                {
                    name: 'macd',
                    type: "line",
                    smooth: true,
                    xAxisIndex: 2,
                    yAxisIndex: 2,
                    data: diff
                }, {
                    name: 'upDN',
                    type: "line",
                    smooth: true,
                    xAxisIndex: 4,
                    yAxisIndex: 4,
                    data: upDN
                },
                {
                    name: 'CQ_buy',
                    type: 'bar',
                    xAxisIndex: 3,
                    yAxisIndex: 3,
                    itemStyle: {
                        color: SAFE_COLOR.red
                    },
                    stack: 'CQ',
                    data: volumesCqBuy
                },
                {
                    name: 'CQ_sell',
                    type: 'bar',
                    xAxisIndex: 3,
                    yAxisIndex: 3,
                    itemStyle: {
                        color: SAFE_COLOR.green
                    },
                    stack: 'CQ',
                    data: volumesCqSell
                }, {
                    name: 'VOL_buy',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    itemStyle: {
                        color: SAFE_COLOR.red
                    },
                    stack: 'vol',
                    data: volNB
                },
                {
                    name: 'VOL_sell',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    itemStyle: {
                        color: SAFE_COLOR.green
                    },
                    stack: 'vol',
                    data: volNS
                }, {
                    name: 'VOL_All',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    itemStyle: {
                        color: SAFE_COLOR.grey
                    },
                    stack: 'vol',
                    data: volAll
                }, {
                    type: 'candlestick',
                    name: '日K',
                    data: dataK,
                    itemStyle: {
                        color: SAFE_COLOR.red,
                        color0: SAFE_COLOR.green,
                        borderColor: SAFE_COLOR.red,
                        borderColor0: SAFE_COLOR.green
                    },
                    markLine: {
                        symbol: "none",
                        label:{show:false},
                        data: [
                            {
                                name: '最新价',
                                yAxis: lastClose,
                                lineStyle: {
                                    color: SAFE_COLOR.yellow
                                }
                            },
                            {
                                name: 'b30up',
                                yAxis: b30up,
                                lineStyle: {
                                    color: SAFE_COLOR.red
                                }
                            },
                            {
                                name: 'b30dn',
                                yAxis: b30dn,
                                lineStyle: {
                                    color: SAFE_COLOR.green
                                }
                            }
                        ]
                    },
                },
                {
                    name: 'vrBuy',
                    type: 'bar',
                    stack: 'vr',
                    xAxisIndex: 5,
                    yAxisIndex: 5,
                    label: {
                        show: false
                    },
                    itemStyle: {
                        color: SAFE_COLOR.yellow,
                        opacity: 0.3
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    data: vrBuy
                },
                {
                    name: 'vrSell',
                    type: 'bar',
                    stack: 'vr',
                    xAxisIndex: 5,
                    yAxisIndex: 5,
                    label: {
                        show: false
                    },
                    itemStyle: {
                        color: SAFE_COLOR.blue,
                        opacity: 0.3
                    },
                    emphasis: {
                        focus: 'series'
                    },
                    data: vrSell
                }
                /*
                {
                    name: 'up',
                    type: 'line',
                    // data: dataMA5,
                    data: bollUP,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        width: 1,
                        color: SAFE_COLOR.yellow
                    }
                }, {
                    name: 'mid',
                    type: 'line',
                    // data: dataMA10,
                    data: bollMID,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        width: 1,
                        color: SAFE_COLOR.black
                    }
                }, {
                    name: 'low',
                    type: 'line',
                    // data: dataMA20,
                    data: bollLOW,
                    smooth: true,
                    showSymbol: false,
                    lineStyle: {
                        width: 1,
                        color: SAFE_COLOR.blue
                    }
                }*/]
        };

        // 使用刚指定的配置项和数据显示图表。
        myChart.setOption(opt);
    };

</script>
</body>

</html>